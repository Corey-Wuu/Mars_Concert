<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mars Concert - æœ€ç»ˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF3E6C',
                        secondary: '#4A90E2',
                        accent: '#FFD166',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #ffb6c1 0%, #ffdde1 50%, #c9e4ff 100%);
            min-height: 100vh;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            width: 100%;
            height: 100%;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
            position: fixed;
        }
        
        /* --- æ–°å¢ï¼šæš—è‰²æ¨¡å¼æç¤ºæ ·å¼ --- */
        #darkModeNotice {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            z-index: 999999; /* ç¡®ä¿åœ¨æœ€ä¸Šå±‚ */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        #darkModeNotice .notice-content {
            background-color: #fff;
            padding: 30px 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            max-width: 90%;
            width: 350px;
        }
        #darkModeNotice h2 {
            color: #5a4a7a;
            font-size: 22px;
            margin-bottom: 15px;
        }
        #darkModeNotice p {
            color: #666;
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 25px;
        }
        #darkModeNotice button {
            background: linear-gradient(135deg, #FF3E6C, #ff6b9d);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 62, 108, 0.3);
        }
        #darkModeNotice button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 62, 108, 0.4);
        }
        #darkModeNotice button:active {
            transform: translateY(0);
        }
        
        /* --- å¯åŠ¨é¡µæ ·å¼ --- */
        .start-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffb6c1 0%, #ffdde1 50%, #c9e4ff 100%);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #5a4a7a;
            text-align: center;
            padding: 20px;
            transition: opacity 0.5s ease-out;
            overflow: hidden;
        }
        
        .start-button {
            background: rgba(255, 255, 255, 0.9);
            color: #e86c8b;
            border: none;
            padding: 18px 45px;
            border-radius: 30px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
            animation: pulse 2s infinite;
            position: relative;
            z-index: 10;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(232, 108, 139, 0.4);
            }
            70% {
                transform: scale(1.05);
                box-shadow: 0 0 0 15px rgba(232, 108, 139, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(232, 108, 139, 0);
            }
        }
        
        .start-button:active { transform: scale(0.95); }
        .start-title { 
            font-size: 26px; 
            margin-bottom: 15px; 
            font-weight: bold; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            position: relative;
            z-index: 10;
        }
        .start-subtitle { 
            font-size: 15px; 
            opacity: 0.8; 
            margin-bottom: 10px; 
            position: relative;
            z-index: 10;
        }

        /* --- éŸ³ä¹æ§åˆ¶æŒ‰é’® --- */
        .music-control {
            position: fixed;
            top: 15px;
            right: 15px;
            z-index: 10001;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 3px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }
        
        .music-control:active { transform: scale(0.95); }
        #bgMusic { display: none; }

        /* --- å¼¹çª—æ ·å¼ --- */
        .windows-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }
        
        .popup-window {
            position: absolute;
            width: 240px;
            height: 70px;
            border-radius: 12px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.6);
            background: rgba(255, 255, 255, 0.9);
            overflow: hidden;
            pointer-events: auto;
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
            will-change: transform, opacity;
            opacity: 0;
        }
        
        .popup-enter {
            animation: fadeInUp 1.2s cubic-bezier(0.25, 0.1, 0.25, 1) forwards, 
                       gentleFloat 8s ease-in-out infinite;
        }
        
        .popup-content {
            background: transparent;
            border-radius: 6px;
            padding: 6px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .lyric-label {
            font-size: 11px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 3px;
            line-height: 1.2;
            padding: 3px 5px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.7);
            color: #5a4a7a;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        
        .bottom-frame { display: flex; align-items: center; justify-content: center; gap: 3px; width: 100%; }
        .flower { font-size: 9px; }
        .middle-text { font-size: 9px; font-weight: bold; color: #5a4a7a; padding: 1px 5px; border-radius: 8px; background: rgba(255, 255, 255, 0.7); }
        
        /* --- åŠ¨ç”»æ•ˆæœ --- */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translate3d(0, 25px, 0) scale(0.95); }
            to { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
        }
        
        @keyframes gentleFloat {
            0%, 100% { transform: translate3d(0, 0, 0); }
            50% { transform: translate3d(0, -3px, 0); }
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
            50% { opacity: 0.7; transform: translate3d(0, 5px, 0) scale(0.98); }
            100% { opacity: 0; transform: translate3d(0, 20px, 0) scale(0.9); }
        }
        
        /* å¼¹å¹•åŠ¨ç”» - ä»å·¦åˆ°å³æ»šåŠ¨ */
        @keyframes bulletScreen {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(calc(100vw + 100%)); }
        }
        
        .popup-exit { animation: fadeOut 1s cubic-bezier(0.16, 1, 0.3, 1) forwards !important; }
        
        /* --- åŠ è½½æ ·å¼ --- */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            text-align: center;
            z-index: 9999;
            background: rgba(90, 74, 122, 0.85);
            padding: 20px;
            border-radius: 15px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }
        
        .loading.active { opacity: 1; }
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* --- èƒŒæ™¯ç‰¹æ•ˆ (å¤ç”¨è‡ªæœ€ç»ˆé¡µé¢) --- */
        .bg-effect { 
            position: absolute;
            pointer-events: none; 
            z-index: 1;
            font-size: 20px; 
            will-change: transform, opacity; 
        }
        .heart { color: #ff6b9d; animation: floatUp 25s linear infinite; }
        .star { color: #ffe066; animation: floatUp 30s linear infinite; }
        .music-note { color: #8a7fff; animation: floatUp 22s linear infinite; }
        
        @keyframes floatUp {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 0.6; }
            90% { opacity: 0.6; }
            100% { transform: translateY(-100px) rotate(180deg); opacity: 0; }
        }
        
        .firework { position: fixed; width: 4px; height: 4px; border-radius: 50%; pointer-events: none; z-index: 2; }
        @keyframes firework {
            0% { transform: translate(var(--x), var(--y)) scale(0); opacity: 1; }
            50% { opacity: 1; }
            100% { transform: translate(var(--x-end), var(--y-end)) scale(1); opacity: 0; }
        }

        @media (max-width: 375px) {
            .popup-window { width: 200px; height: 65px; }
        }

        /* --- æœ€ç»ˆé¡µé¢æ ·å¼ (å¼¹å¹•ç‰ˆ) --- */
        #finalMessage {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom right, #1a1a2e, #16213e, #0f3460);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Inter', system-ui, sans-serif;
            color: white;
            z-index: 5000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 1s ease-in-out;
            cursor: pointer;
        }
        
        #particles-js {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 0;
        }
        
        /* è£…é¥°å…ƒç´ å®¹å™¨ */
        .decorations-container {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            z-index: 1;
        }
        
        .decor-element {
            position: absolute;
            opacity: 0;
            transition: opacity 1s ease-out;
        }
        
        .decor-top-left { top: 20%; left: 15%; animation: float 6s ease-in-out infinite; }
        .decor-top-right { top: 15%; right: 15%; animation: float 7s ease-in-out infinite; }
        .decor-bottom-left { bottom: 20%; left: 20%; animation: float 8s ease-in-out infinite; }
        .decor-bottom-right { bottom: 15%; right: 20%; animation: float 9s ease-in-out infinite; }
        
        @keyframes float {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-15px) rotate(5deg); }
        }
        
        /* --- æ–‡å­—æ ·å¼ä¼˜åŒ– --- */
        
        .text-container {
            position: relative;
            z-index: 4;
            text-align: center;
            max-width: 90%;
            padding: 1.5rem;
            border-radius: 20px;
            pointer-events: none;
        }
        
        #text1, #text2 {
            font-weight: bold;
            margin-bottom: 1.5rem;
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            line-height: 1.3;
            white-space: nowrap;
            width: 100%;
        }
        
        #text1 {
            font-size: clamp(1.2rem, 4.5vw, 2.8rem);
            color: #FFD166;
        }
        
        #text2 {
            font-size: clamp(1.3rem, 4vw, 2.2rem);
            font-weight: 600;
            margin-bottom: 2rem;
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            background-image: linear-gradient(to right, #4A90E2, #FFD166);
        }
        
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .animate-typewriter {
            animation: 
                fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards,
                typing 4s steps(60, end) forwards;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes typing {
            from { clip-path: inset(0 100% 0 0); }
            to { clip-path: inset(0 0 0 0); }
        }

        .animate-float-in {
            animation: floatIn 1.5s cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        /* åˆ†éš”çº¿æ ·å¼ */
        #divider {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 0 auto;
            max-width: 60%;
            opacity: 0;
            transform: scaleX(0);
            transition: opacity 1s ease-out, transform 1s ease-out;
        }
        
        #divider .line {
            flex: 1;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.5), transparent);
        }
        
        #divider .star-icon {
            color: #FFD166;
            font-size: 1.5rem;
        }
        
        /* --- å¼¹å¹•æ ·å¼ --- */
        .bullet-screen-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3;
            overflow: hidden;
        }
        
        .bullet {
            position: absolute;
            white-space: nowrap;
            padding: 8px 15px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.9);
            color: #5a4a7a;
            font-size: clamp(0.9rem, 1.5vw, 1.1rem);
            font-weight: 600;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
            animation: bulletScreen linear infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        /* å¼¹å¹•èƒŒæ™¯æ¡†é¢œè‰²å˜ä½“ */
        .bullet-color1 { background: rgba(255, 94, 108, 0.9); color: white; }
        .bullet-color2 { background: rgba(74, 144, 226, 0.9); color: white; }
        .bullet-color3 { background: rgba(255, 209, 102, 0.9); color: #333; }
        .bullet-color4 { background: rgba(138, 127, 255, 0.9); color: white; }
        .bullet-color5 { background: rgba(107, 255, 184, 0.9); color: #333; }
    </style>
</head>
<body>
    <!-- æ–°å¢ï¼šæš—è‰²æ¨¡å¼æç¤ºæ¡† -->
    <div id="darkModeNotice">
        <div class="notice-content">
            <h2>è§‚çœ‹ä½“éªŒæç¤º</h2>
            <p>ä¸ºäº†æ›´å¥½åœ°æ¬£èµé¡µé¢æ•ˆæœï¼Œå»ºè®®æ‚¨å…³é—­ç³»ç»Ÿçš„â€œæš—è‰²æ¨¡å¼â€æˆ–â€œå¤œé—´æ¨¡å¼â€ã€‚</p>
            <button id="noticeConfirmBtn">æˆ‘çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- å¯åŠ¨è¦†ç›–å±‚ -->
    <div class="start-overlay" id="startOverlay">
        <div class="start-title">ğŸŒ¸ Mars Concert ğŸŒ¸</div>
        <div class="start-subtitle">æœ‰ä¸ªå°ç§˜å¯†æƒ³å‘Šè¯‰ä½ </div>
        <button class="start-button" id="startButton">å¼€å¯</button>
    </div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="bgMusic" loop preload="none">
        <!-- åŠ¨æ€æ’å…¥éŸ³ä¹æº -->
    </audio>
    
    <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <button class="music-control" id="musicButton" style="display: none;">ğŸ”Š</button>
    
    <!-- å¼¹çª—å®¹å™¨ -->
    <div class="windows-container" id="windowsContainer"></div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <div>ç§˜å¯†åŠ è½½ä¸­...</div>
    </div>

    <!-- æœ€ç»ˆç¥ç¦é¡µé¢ (å¼¹å¹•ç‰ˆ) -->
    <div id="finalMessage">
        <div id="particles-js"></div>
        
        <!-- è£…é¥°å…ƒç´ å®¹å™¨ -->
        <div class="decorations-container">
            <div class="decor-element decor-top-left">ğŸµ</div>
            <div class="decor-element decor-top-right">â­</div>
            <div class="decor-element decor-bottom-left">ğŸµâ­</div>
            <div class="decor-element decor-bottom-right">â­ğŸµ</div>
        </div>
        
        <!-- å¼¹å¹•å®¹å™¨ -->
        <div class="bullet-screen-container" id="bulletScreenContainer"></div>
        
        <!-- æ–‡å­—å®¹å™¨ -->
        <div class="text-container">
            <div class="mb-8 animate-float">
                <i class="fa fa-music text-6xl text-[#FFD166] opacity-80" aria-hidden="true"></i>
            </div>
            
            <h1 id="text1">æ„¿åæ™¨å®‡çš„éŸ³ä¹æ°¸è¿œé™ªä¼´æ‚¨</h1>
            <h2 id="text2">ç¾å¥½ä¸ä½ åŒåœ¨</h2>
            
            <div id="divider">
                <div class="line"></div>
                <div class="star-icon">
                    <i class="fa fa-star" aria-hidden="true"></i>
                </div>
                <div class="line"></div>
            </div>
        </div>
    </div>

    <!-- å…ˆåŠ è½½ç²’å­åº“ -->
    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    
    <!-- æ–°å¢ï¼šæ§åˆ¶æç¤ºæ¡†æ˜¾ç¤ºçš„è„šæœ¬ -->
    <script>
        // ç­‰å¾…é¡µé¢DOMå®Œå…¨åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            const notice = document.getElementById('darkModeNotice');
            const confirmBtn = document.getElementById('noticeConfirmBtn');
            
            // å½“ç”¨æˆ·ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œéšè—æç¤ºæ¡†
            confirmBtn.addEventListener('click', function() {
                notice.style.opacity = '0';
                // ç­‰å¾…åŠ¨ç”»ç»“æŸåï¼Œå®Œå…¨ç§»é™¤æç¤ºæ¡†
                setTimeout(() => {
                    notice.style.display = 'none';
                }, 500); // ä¸CSSä¸­çš„transitionæ—¶é—´ä¿æŒä¸€è‡´
            });
        });
    </script>
    
    <script>
        // --- ä¸»é€»è¾‘ ---
        const lyrics = [
            "è®°å¾—å¥½å¥½åƒé¥­å‘€",
            "è¦æ—©ç‚¹ä¼‘æ¯å“¦",
            "ä»Šå¤©ä¹Ÿè¦å¼€å¿ƒå•Š",
            "è¦å¥½å¥½çˆ±è‡ªå·±",
            "ä½ å€¼å¾—è¢«æ¸©æŸ”ä»¥å¾…",
            "ä½ è¶…çº§æ£’çš„ï¼",
            "ç›¸ä¿¡è‡ªå·±ï¼Œä½ å¯ä»¥",
            "æ²¡å…³ç³»ï¼Œæ…¢æ…¢æ¥",
            "æˆ‘ä»¬ä¸ºä½ éª„å‚²",
            "ä¸€èµ·åŠ æ²¹å§ï¼",
            "å‰æ–¹å¿…å®šæœ‰å…‰",
            "åˆ«æ€•ï¼Œæˆ‘ä»¬éƒ½åœ¨",
            "ä½ å·²ç»åšå¾—å¾ˆå¥½äº†",
            "å…±åŒæˆé•¿ï¼ŒçœŸå¥½",
            "å‰ç¨‹ä¼¼é”¦å‘€",
            "æ„¿ä½ è¢«ä¸–ç•Œæ¸©æŸ”ç›¸æ‹¥",
            "å¿ƒæƒ³äº‹æˆå“¦",
            "ç¥ä½ ä¸€åˆ‡éƒ½å¥½",
            "è®°å¾—æŒ‰æ—¶åƒé¥­",
            "æˆ‘ä»¬ä¸‹æ¬¡ç«æ˜Ÿè§ï¼ï¼ï¼",
            "å°†æœ‰ä¸€å¤©ä½ ä¼šé‡è§ç¾å¥½çš„ä¸€åˆ‡",
            "å¤•é˜³è¥¿ä¸‹æ¥é€šç”µè¯æ˜¯ä½ å‘€",
            "è‡³é«˜æ— ä¸Šçš„å‘½è¿å•Š",
            "è¿‡å»å•Šï¼Œè¿‡å»å•¦",
            "å°†æœ‰ä¸€å¤©ä½ ä¼šæ‹¥æœ‰ç¾å¥½çš„ç”Ÿæ´»",
            "å¤§å¤šçˆ±çš„åä¹‰å¥”èµ´åœ¨æˆ‘çš„é¢†åœ°",
            "æ¬¢è¿å›å®¶",
            "æˆ‘ä»¬çš„æ•…äº‹ä¸€å®šä¼šè®²åˆ°è€",
            "åˆ«æ€• åˆ«æ€•",
            "æ”¾ä¸‹æ‰å¾—åˆ°æ›´å¥½å•Š",
            "å½“ä½ çš„ç¬‘å®¹ç»½å¼€",
            "é‚£äº›é»‘æš—ç¬¼ç½©çš„ç»ˆå°†å‘é˜³è€Œç”Ÿ",
            "ç»ˆé—ªè€€",
            "æˆ‘ä»¬çš„ä¸–ç•Œä¸€ç›´ä¼šå¾ˆç¾å¥½",
            "é™ªç€\"æˆ‘\"å§",
            "è¿™ä¸–ç•Œçªç„¶å¡«æ»¡è‰²å½©",
            "å›åˆ°åœ°çƒä¸Šè¦å¥½å¥½çš„ç”Ÿæ´»"
        ];
        const bgColors = [
            'rgba(255, 230, 240, 0.9)', 'rgba(230, 240, 255, 0.9)', 
            'rgba(230, 255, 240, 0.9)', 'rgba(255, 255, 230, 0.9)', 
            'rgba(240, 230, 255, 0.9)', 'rgba(255, 240, 230, 0.9)'
        ];
        const bulletColorClasses = ['bullet-color1', 'bullet-color2', 'bullet-color3', 'bullet-color4', 'bullet-color5'];
        let windows = []; let closeAnimationRunning = false; 
        const maxWindows = 70; const createBatch = 1; 
        const createInterval = 450; const closeDelay = 5000; const closeBatch = 6; const closeBatchInterval = 200; 
        let closeTimeout = null; let fireworkInterval = null; let audio = null; let backgroundElements = [];
        let bulletInterval = null; 
        let startPageBackgroundElements = []; 

        // éŸ³ä¹æ–‡ä»¶åˆ—è¡¨ (å·²ç§»é™¤æŒ‡å®šæ­Œæ›²)
        const musicFiles = [
            'å°ç¾ä¸½å‰ä»–solo.mp3',
            'å‘é˜³è€Œç”Ÿé—´å¥.mp3',
            'å°å›é—´å¥.mp3',
            'boringé’¢ç´ç‰ˆ.mp3',
            'å°æ€ªè¯é’¢ç´ç‰ˆ.mp3'
        ];

        function init() {
            try {
                audio = document.getElementById('bgMusic');
                audio.volume = 0.6;
                document.getElementById('startButton').addEventListener('click', startExperience);
                document.getElementById('musicButton').addEventListener('click', toggleMusic);
                
                // ç¡®ä¿å¯åŠ¨é¡µå¯è§
                document.getElementById('startOverlay').style.display = 'flex';

                // åˆ›å»ºå¯åŠ¨é¡µçš„åŠ¨æ€èƒŒæ™¯æ•ˆæœ
                createStartPageBackgroundEffects();

            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                showErrorScreen();
            }
        }

        function createStartPageBackgroundEffects() {
            try {
                const startOverlay = document.getElementById('startOverlay');
                const elements = [
                    { symbols: ['â¤ï¸', 'ğŸ’–'], class: 'heart', count: 3 },
                    { symbols: ['â­', 'ğŸŒŸ'], class: 'star', count: 2 },
                    { symbols: ['ğŸµ'], class: 'music-note', count: 2 }
                ];
                elements.forEach(item => {
                    for (let i = 0; i < item.count; i++) {
                        const el = document.createElement('div');
                        el.className = `bg-effect ${item.class}`;
                        el.textContent = item.symbols[Math.floor(Math.random() * item.symbols.length)];
                        el.style.left = `${Math.random() * 100}%`;
                        el.style.bottom = '-50px';
                        el.style.fontSize = `${12 + Math.random() * 10}px`;
                        el.style.animationDelay = `${Math.random() * 15}s`;
                        
                        startOverlay.appendChild(el);
                        startPageBackgroundElements.push(el);
                    }
                });
            } catch (error) {
                console.error('åˆ›å»ºå¯åŠ¨é¡µèƒŒæ™¯æ•ˆæœé”™è¯¯:', error);
            }
        }

        function startExperience() {
            try {
                // æ¸…ç†å¯åŠ¨é¡µçš„èƒŒæ™¯å…ƒç´ 
                startPageBackgroundElements.forEach(el => {
                    if (el && el.parentNode) {
                        el.parentNode.removeChild(el);
                    }
                });
                startPageBackgroundElements = [];

                document.getElementById('startOverlay').style.opacity = 0;
                setTimeout(() => { document.getElementById('startOverlay').style.display = 'none'; }, 500);
                document.getElementById('loading').classList.add('active');
                createBackgroundEffects();
                
                // éšæœºé€‰æ‹©ä¸€ä¸ªéŸ³ä¹æ–‡ä»¶å¹¶åŠ è½½
                loadRandomMusic();
                
                // å»¶è¿Ÿåˆ›å»ºå¼¹çª—ï¼Œç¡®ä¿DOMå·²å‡†å¤‡å¥½
                setTimeout(() => {
                    document.getElementById('loading').classList.remove('active');
                    windows = [];
                    // ç«‹å³åˆ›å»ºç¬¬ä¸€ä¸ªå¼¹çª—ï¼Œç¡®ä¿èƒ½çœ‹åˆ°
                    createSinglePopup(0);
                    // å¼€å§‹æ‰¹é‡åˆ›å»ºå…¶ä»–å¼¹çª—
                    setTimeout(() => {
                        batchCreatePopup(1);
                    }, createInterval);
                }, 800);
            } catch (error) {
                console.error('å¯åŠ¨ä½“éªŒé”™è¯¯:', error);
                showErrorScreen();
            }
        }

        // éšæœºåŠ è½½éŸ³ä¹
        function loadRandomMusic() {
            try {
                if (musicFiles.length === 0) {
                    console.warn('éŸ³ä¹åˆ—è¡¨ä¸ºç©ºï¼');
                    return;
                }
                // éšæœºé€‰æ‹©ä¸€ä¸ªéŸ³ä¹æ–‡ä»¶
                const randomIndex = Math.floor(Math.random() * musicFiles.length);
                const musicFile = musicFiles[randomIndex];
                
                // æ¸…ç©ºç°æœ‰æº
                audio.innerHTML = '';
                
                // æ·»åŠ MP3æº
                const mp3Source = document.createElement('source');
                mp3Source.src = musicFile;
                mp3Source.type = 'audio/mpeg';
                audio.appendChild(mp3Source);
                
                // å°è¯•åŠ è½½å¹¶æ’­æ”¾
                audio.load();
                audio.play().catch(err => {
                    console.error('éŸ³ä¹æ’­æ”¾å¤±è´¥ï¼Œå°è¯•å†æ¬¡æ’­æ”¾:', err);
                    // å†æ¬¡å°è¯•æ’­æ”¾ï¼ˆç”¨æˆ·äº¤äº’åï¼‰
                    setTimeout(() => {
                        audio.play().catch(err2 => {
                            console.error('å†æ¬¡æ’­æ”¾å¤±è´¥:', err2);
                            // å¦‚æœä»ç„¶å¤±è´¥ï¼Œå¯ä»¥æ˜¾ç¤ºé”™è¯¯æˆ–åˆ‡æ¢éŸ³ä¹
                            showMusicError();
                        });
                    }, 1000);
                });
                
                document.getElementById('musicButton').style.display = 'flex';
                
                // æ·»åŠ éŸ³é¢‘é”™è¯¯å¤„ç†
                audio.addEventListener('error', () => {
                    console.error('éŸ³é¢‘åŠ è½½é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢éŸ³ä¹');
                    loadRandomMusic(); // å°è¯•åŠ è½½å…¶ä»–éŸ³ä¹
                });
                
            } catch (error) {
                console.error('åŠ è½½éšæœºéŸ³ä¹é”™è¯¯:', error);
                showMusicError();
            }
        }

        // éŸ³ä¹åŠ è½½é”™è¯¯æç¤º
        function showMusicError() {
            alert('éŸ³ä¹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢');
        }

        function createBackgroundEffects() {
            try {
                if (fireworkInterval) clearInterval(fireworkInterval);
                backgroundElements.forEach(el => el.remove());
                backgroundElements = [];
                fireworkInterval = setInterval(() => {
                    const x = Math.random() * window.innerWidth;
                    const y = Math.random() * window.innerHeight * 0.6;
                    createFirework(x, y);
                }, 4000);
                const elements = [
                    { symbols: ['â¤ï¸', 'ğŸ’–'], class: 'heart', count: 4 },
                    { symbols: ['â­', 'ğŸŒŸ'], class: 'star', count: 3 },
                    { symbols: ['ğŸµ'], class: 'music-note', count: 2 }
                ];
                elements.forEach(item => {
                    for (let i = 0; i < item.count; i++) {
                        const el = document.createElement('div');
                        el.className = `bg-effect ${item.class}`;
                        el.textContent = item.symbols[Math.floor(Math.random() * item.symbols.length)];
                        el.style.left = `${Math.random() * 100}%`;
                        el.style.fontSize = `${14 + Math.random() * 12}px`;
                        el.style.animationDelay = `${Math.random() * 10}s`;
                        document.body.appendChild(el);
                        backgroundElements.push(el);
                        setTimeout(() => {
                            const index = backgroundElements.indexOf(el);
                            if (index > -1) backgroundElements.splice(index, 1);
                            el.remove();
                        }, 30000);
                    }
                });
            } catch (error) {
                console.error('åˆ›å»ºèƒŒæ™¯æ•ˆæœé”™è¯¯:', error);
            }
        }

        function createFirework(x, y) {
            try {
                const colors = ['#ff6b9d', '#ffe066', '#8a7fff', '#6bffb8'];
                for (let i = 0; i < 6; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'firework';
                    particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    particle.style.left = `${x}px`; particle.style.top = `${y}px`;
                    const angle = Math.random() * Math.PI * 2; const distance = 20 + Math.random() * 40;
                    particle.style.setProperty('--x-end', `${Math.cos(angle) * distance}px`);
                    particle.style.setProperty('--y-end', `${Math.sin(angle) * distance}px`);
                    particle.style.animation = 'firework 1s ease-out forwards';
                    document.body.appendChild(particle);
                    setTimeout(() => particle.remove(), 1000);
                }
            } catch (error) {
                console.error('åˆ›å»ºçƒŸèŠ±æ•ˆæœé”™è¯¯:', error);
            }
        }

        function createClickFirework(e) {
            if (e.target.id !== 'finalMessage') return;

            const x = e.clientX;
            const y = e.clientY;
            const colors = ['#ff6b9d', '#ffe066', '#8a7fff', '#6bffb8', '#ff9a8b', '#a8edea'];
            for (let i = 0; i < 10; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                const angle = Math.random() * Math.PI * 2;
                const distance = 15 + Math.random() * 50;
                particle.style.setProperty('--x-end', `${Math.cos(angle) * distance}px`);
                particle.style.setProperty('--y-end', `${Math.sin(angle) * distance}px`);
                const duration = 0.8 + Math.random() * 0.5;
                particle.style.animation = `firework ${duration}s ease-out forwards`;
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), duration * 1000);
            }
        }

        function batchCreatePopup(startIndex) {
            try {
                if (startIndex >= maxWindows) {
                    closeTimeout = setTimeout(() => { closeAllPopups(); }, closeDelay);
                    return;
                }
                const endIndex = Math.min(startIndex + createBatch, maxWindows);
                for (let i = startIndex; i < endIndex; i++) {
                    const delay = Math.random() * 150;
                    setTimeout(() => { createSinglePopup(i); }, delay);
                }
                setTimeout(() => { batchCreatePopup(endIndex); }, createInterval);
            } catch (error) {
                console.error('æ‰¹é‡åˆ›å»ºå¼¹çª—é”™è¯¯:', error);
            }
        }

        function createSinglePopup(index) {
            try {
                const popup = document.createElement('div');
                popup.className = 'popup-window'; 
                popup.dataset.index = index;
                
                const width = window.innerWidth < 375 ? 200 : 240; 
                const height = window.innerWidth < 375 ? 65 : 70;
                const x = (Math.random() * (window.innerWidth - width + 40)) - 20;
                const y = Math.random() * (window.innerHeight - height - 20) + 10;
                
                popup.style.left = `${x}px`; 
                popup.style.top = `${y}px`; 
                popup.style.width = `${width}px`; 
                popup.style.height = `${height}px`;
                popup.style.backgroundColor = bgColors[Math.floor(Math.random() * bgColors.length)];
                
                const lyric = lyrics[Math.floor(Math.random() * lyrics.length)];
                popup.innerHTML = `
                    <div class="popup-content">
                        <div class="lyric-label">${lyric}</div>
                        <div class="bottom-frame">
                            <div class="flower">ğŸŒ¸</div>
                            <div class="middle-text">Mars Concert</div>
                            <div class="flower">ğŸŒ¸</div>
                        </div>
                    </div>
                `;
                
                const container = document.getElementById('windowsContainer');
                if (container) {
                    container.appendChild(popup);
                    windows.push(popup);
                    
                    setTimeout(() => {
                        popup.classList.add('popup-enter');
                    }, 10);
                }
            } catch (error) {
                console.error('åˆ›å»ºå•ä¸ªå¼¹çª—é”™è¯¯:', error);
            }
        }

        function closeAllPopups() {
            try {
                if (closeAnimationRunning) return;
                closeAnimationRunning = true;
                let closedCount = 0; 
                const total = windows.length;
                
                if (total === 0) {
                    checkAllClosed();
                    return;
                }

                function batchClose(startIndex) {
                    if (startIndex >= total) return;
                    const endIndex = Math.min(startIndex + closeBatch, total);
                    for (let i = startIndex; i < endIndex; i++) {
                        const popup = windows[i];
                        if (popup && !popup.classList.contains('popup-exit')) {
                            const delay = Math.random() * 200;
                            setTimeout(() => {
                                popup.classList.add('popup-exit');
                                setTimeout(() => { 
                                    popup.remove(); 
                                    closedCount++; 
                                    checkAllClosed(); 
                                }, 1000);
                            }, delay);
                        } else { 
                            if (popup) popup.remove();
                            closedCount++; 
                            checkAllClosed(); 
                        }
                    }
                    setTimeout(() => { batchClose(endIndex); }, closeBatchInterval);
                }
                
                function checkAllClosed() {
                    if (closedCount === total) {
                        setTimeout(showFinalMessage, 1000); 
                    }
                }
                
                batchClose(0);
            } catch (error) {
                console.error('å…³é—­æ‰€æœ‰å¼¹çª—é”™è¯¯:', error);
                showFinalMessage();
            }
        }
        
        function createBulletScreen() {
            try {
                const bulletContainer = document.getElementById('bulletScreenContainer');
                if (!bulletContainer) return;
                
                const lyric = lyrics[Math.floor(Math.random() * lyrics.length)];
                const bullet = document.createElement('div');
                bullet.className = 'bullet';
                const colorClass = bulletColorClasses[Math.floor(Math.random() * bulletColorClasses.length)];
                bullet.classList.add(colorClass);
                bullet.textContent = lyric;
                
                const top = Math.random() * 100;
                bullet.style.top = `${top}%`;
                if (top > 40 && top < 60) {
                    bullet.style.top = top < 50 ? `${top - 20}%` : `${top + 20}%`;
                }
                
                const duration = 8 + Math.random() * 7;
                bullet.style.animationDuration = `${duration}s`;
                
                bulletContainer.appendChild(bullet);
                
                setTimeout(() => {
                    bullet.style.opacity = '1';
                }, Math.random() * 500);
                
                setTimeout(() => {
                    bullet.style.opacity = '0';
                    setTimeout(() => {
                        bullet.remove();
                    }, 300);
                }, duration * 1000);
            } catch (error) {
                console.error('åˆ›å»ºå¼¹å¹•é”™è¯¯:', error);
            }
        }
        
        function showFinalMessage() {
            try {
                closeAnimationRunning = false;
                
                if (fireworkInterval) {
                    clearInterval(fireworkInterval);
                    fireworkInterval = null;
                }
                backgroundElements.forEach(el => {
                    if (el && el.parentNode) el.parentNode.removeChild(el);
                });
                backgroundElements = [];
                
                const musicBtn = document.getElementById('musicButton');
                if (musicBtn) musicBtn.style.display = 'none';
                
                const finalMessageDiv = document.getElementById('finalMessage');
                if (finalMessageDiv) {
                    finalMessageDiv.style.opacity = '1';
                    finalMessageDiv.style.pointerEvents = 'auto';
                    finalMessageDiv.addEventListener('click', createClickFirework);
                }

                try {
                    if (typeof particlesJS !== 'undefined') {
                        particlesJS("particles-js", {
                            particles: {
                                number: { value: 80, density: { enable: true, value_area: 800 } },
                                color: { value: "#ffffff" },
                                shape: { type: "circle" },
                                opacity: { value: 0.5, random: true },
                                size: { value: 3, random: true },
                                line_linked: {
                                    enable: true,
                                    distance: 150,
                                    color: "#ffffff",
                                    opacity: 0.2,
                                    width: 1
                                },
                                move: {
                                    enable: true,
                                    speed: 1,
                                    direction: "none",
                                    random: true,
                                    straight: false,
                                    out_mode: "out",
                                    bounce: false
                                }
                            },
                            interactivity: {
                                detect_on: "canvas",
                                events: {
                                    onhover: { enable: true, mode: "grab" },
                                    onclick: { enable: true, mode: "push" },
                                    resize: true
                                },
                                modes: {
                                    grab: { distance: 140, line_linked: { opacity: 0.5 } },
                                    push: { particles_nb: 3 }
                                }
                            },
                            retina_detect: true
                        });
                    }
                } catch (err) {
                    console.log('ç²’å­æ•ˆæœåˆå§‹åŒ–å¤±è´¥:', err);
                }
                
                const decorElements = document.querySelectorAll('.decor-element');
                decorElements.forEach((el, index) => {
                    setTimeout(() => {
                        el.style.opacity = '0.8';
                        el.style.fontSize = `${Math.floor(20 + Math.random() * 15)}px`;
                    }, 500 + index * 300);
                });
                
                const text1 = document.getElementById('text1');
                const text2 = document.getElementById('text2');
                const divider = document.getElementById('divider');

                setTimeout(() => {
                    text1.classList.add('animate-typewriter');
                }, 500);

                setTimeout(() => {
                    text2.classList.add('animate-float-in');
                }, 5000);

                setTimeout(() => {
                    divider.style.opacity = '1';
                    divider.style.transform = 'scaleX(1)';

                    setTimeout(() => {
                        bulletInterval = setInterval(() => {
                            createBulletScreen();
                        }, 200 + Math.random() * 300);
                    }, 1000);

                }, 7000);

            } catch (error) {
                console.error('æ˜¾ç¤ºæœ€ç»ˆé¡µé¢é”™è¯¯:', error);
                showErrorScreen();
            }
        }

        function toggleMusic() {
            try {
                const btn = document.getElementById('musicButton');
                if (audio.paused) { 
                    audio.play(); 
                    btn.textContent = 'ğŸ”Š'; 
                } else { 
                    audio.pause(); 
                    btn.textContent = 'ğŸµ'; 
                }
            } catch (error) {
                console.error('åˆ‡æ¢éŸ³ä¹é”™è¯¯:', error);
            }
        }
        
        function showErrorScreen() {
            if (bulletInterval) clearInterval(bulletInterval);
            if (fireworkInterval) clearInterval(fireworkInterval);
            if (closeTimeout) clearTimeout(closeTimeout);
            
            const errorDiv = document.createElement('div');
            errorDiv.style.position = 'fixed';
            errorDiv.style.top = '0';
            errorDiv.style.left = '0';
            errorDiv.style.width = '100%';
            errorDiv.style.height = '100%';
            errorDiv.style.backgroundColor = 'white';
            errorDiv.style.display = 'flex';
            errorDiv.style.flexDirection = 'column';
            errorDiv.style.alignItems = 'center';
            errorDiv.style.justifyContent = 'center';
            errorDiv.style.zIndex = '99999';
            
            errorDiv.innerHTML = `
                <div style="font-size: 24px; color: red; margin-bottom: 20px;">é¡µé¢åŠ è½½å‡ºé”™</div>
                <div style="margin-bottom: 30px; text-align: center; padding: 0 20px;">
                    è¯·å°è¯•åˆ·æ–°é¡µé¢æˆ–ä½¿ç”¨å…¶ä»–æµè§ˆå™¨è®¿é—®
                </div>
                <button id="reloadButton" style="padding: 10px 20px; font-size: 16px; cursor: pointer;">
                    åˆ·æ–°é¡µé¢
                </button>
            `;
            
            document.body.appendChild(errorDiv);
            document.getElementById('reloadButton').addEventListener('click', () => {
                window.location.reload();
            });
        }

        window.addEventListener('beforeunload', () => {
            if (bulletInterval) clearInterval(bulletInterval);
            if (fireworkInterval) clearInterval(fireworkInterval);
            if (closeTimeout) clearTimeout(closeTimeout);
        });

        document.addEventListener('DOMContentLoaded', init);
        
        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
        document.addEventListener('gesturestart', (e) => e.preventDefault());
    </script>
</body>
</html>